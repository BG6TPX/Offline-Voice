C51 COMPILER V9.00   MAIN                                                                  04/24/2013 16:05:04 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\obj\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\code\main.c BROWSE INCDIR(..\code;..\user) DEBUG OBJECTEXTEND PRINT(.\ma
                    -in.lst) OBJECT(..\obj\main.obj)

line level    source

   1          /*************************飞音云电子******************************************
   2          **      版权所有：Copyright (c) 2005 - 2010 ICRoute INC.
   3          **      CPU: STC89LE52
   4          **      晶振：22.1184MHZ
   5          **      波特率：9600 bit/S
   6          **      配套产品信息：V0.3语音开发板
   7          **                http://yuesheng001.taobao.com/
   8          **  版本：zds0.0.3
   9          **  修改日期：2011.12.10
  10          **  说明：本工程只具有 语音识别功能。属基本驱动代码，
  11                                                  附加串口、如不需要用到可
  12                                                  屏蔽删除，根据需要自行移植到相关的单片机上。
  13          本程序中带/*text.....*///为串口打印输出提示内容，查看工作状态使用的，可以全部删除
  14          
  15          /************************************************************************************/
  16          #include "config.h"
  17          
  18          /************************************************************************************/
  19          //      nAsrStatus 用来在main主程序中表示程序运行的状态，不是LD3320芯片内部的状态寄存器
  20          //      LD_ASR_NONE:            表示没有在作ASR识别
  21          //      LD_ASR_RUNING：         表示LD3320正在作ASR识别中
  22          //      LD_ASR_FOUNDOK:         表示一次识别流程结束后，有一个识别结果
  23          //      LD_ASR_FOUNDZERO:       表示一次识别流程结束后，没有识别结果
  24          //      LD_ASR_ERROR:           表示一次识别流程中LD3320芯片内部出现不正确的状态
  25          /***********************************************************************************/
  26          uint8 idata nAsrStatus=0;       
  27          extern void   _nop_     (void); 
  28          void MCU_init(); 
  29          uint8 RunASR();
  30          void ProcessInt0(); //识别处理函数
  31          void  delay(unsigned long uldata);
  32          /************************************************************************
  33          功能描述： 主函数程序入口
  34          入口参数：      none
  35          返 回 值：      none
  36          其他说明：      none
  37          **************************************************************************/
  38          void  main()
  39          {
  40   1              uint8 idata nAsrRes;
  41   1              uint8 i=0;
  42   1      
  43   1              MCU_init();
  44   1              LD_Reset();
  45   1              UartIni(); /*串口初始化*/
  46   1              nAsrStatus = LD_ASR_NONE;               //      初始状态：没有在作ASR
  47   1              PrintCom("串口运行中....\n"); /*text.....*/
  48   1              PrintCom("口令：1、代码测试\n"); /*text.....*/
  49   1              PrintCom("      2、开发板验证\n"); /*text.....*/
  50   1              PrintCom("      3、检查完毕\n"); /*text.....*/
  51   1      
  52   1              while(1)
  53   1              {
  54   2                      switch(nAsrStatus)
C51 COMPILER V9.00   MAIN                                                                  04/24/2013 16:05:04 PAGE 2   

  55   2                      {
  56   3                              case LD_ASR_RUNING:
  57   3                              case LD_ASR_ERROR:              
  58   3                                      break;
  59   3                              case LD_ASR_NONE:
  60   3                              {
  61   4                                      nAsrStatus=LD_ASR_RUNING;
  62   4                                      if (RunASR()==0)        /*      启动一次ASR识别流程：ASR初始化，ASR添加关键词语，启动ASR运算*/
  63   4                                      {
  64   5                                              nAsrStatus = LD_ASR_ERROR;
  65   5                                      }
  66   4                                      break;
  67   4                              }
  68   3      
  69   3                              case LD_ASR_FOUNDOK: /* 一次ASR识别流程结束，去取ASR识别结果*/
  70   3                              {
  71   4                                      
  72   4                                      nAsrRes = LD_GetResult();               /*获取结果*/
  73   4                                      PrintCom("\n识别码:"); /*text.....*/
  74   4                               UARTSendByte(nAsrRes+0x30); /*text.....*/                              
  75   4                                       switch(nAsrRes)                   /*对结果执行相关操作,客户修改*/
  76   4                                        {
  77   5                                                case CODE_DMCS:                       /*命令“测试”*/
  78   5                                                              PrintCom("“代码测试”命令识别成功\n"); /*text.....*/
  79   5                                                                                                                       break;
  80   5                                                      case CODE_KFBYZ:         /*命令“全开”*/
  81   5                                                              PrintCom("“开发板验证”命令识别成功\n"); /*text.....*/
  82   5                                                                                                                       break;
  83   5                                                      case CODE_JCWB:         /*命令“复位”*/
  84   5                                      
  85   5                                                              PrintCom("“检查完毕”命令识别成功\n"); /*text.....*/
  86   5                                                                                                                      break;
  87   5                                                      default:break;
  88   5                                              }                               
  89   4      
  90   4                                      nAsrStatus = LD_ASR_NONE;
  91   4                                      break;
  92   4                              }
  93   3                              case LD_ASR_FOUNDZERO:
  94   3                              default:
  95   3                              {
  96   4                                      nAsrStatus = LD_ASR_NONE;
  97   4                                      break;
  98   4                              }
  99   3                      }// switch       
 100   2              }// while
 101   1      
 102   1      }
 103          /************************************************************************
 104          功能描述：      单片机初始化
 105          入口参数：
 106          返 回 值： 
 107          其他说明：
 108          **************************************************************************/
 109          void MCU_init()
 110          {
 111   1              P0 = 0xff;
 112   1              P1 = 0xff;
 113   1              P2 = 0xff;
 114   1              P3 = 0xf7;
 115   1              IE0=1;
 116   1              EX0=1;
C51 COMPILER V9.00   MAIN                                                                  04/24/2013 16:05:04 PAGE 3   

 117   1              EA=1;
 118   1      }
 119          
 120          /************************************************************************
 121          功能描述： 延时函数
 122          调用函数： 
 123          入口参数： 
 124          返回函数： 
 125          **************************************************************************/
 126          void  delay(unsigned long uldata)
 127          {
 128   1              unsigned int j  =  0;
 129   1              unsigned int g  =  0;
 130   1              for (j=0;j<5;j++)
 131   1              {
 132   2                      for (g=0;g<uldata;g++)
 133   2                      {
 134   3                              _nop_();
 135   3                              _nop_();
 136   3                              _nop_();
 137   3                      }
 138   2              }
 139   1      }
 140          /************************************************************************
 141          功能描述：      运行ASR识别流程
 142          入口参数：      none
 143          返 回 值：  asrflag：1->启动成功， 0―>启动失败
 144          其他说明：      识别顺序如下:
 145                                                          1、RunASR()函数实现了一次完整的ASR语音识别流程
 146                                                          2、LD_AsrStart() 函数实现了ASR初始化
 147                                                          3、LD_AsrAddFixed() 函数实现了添加关键词语到LD3320芯片中
 148                                                          4、LD_AsrRun()  函数启动了一次ASR语音识别流程                                   
 149                                                          任何一次ASR识别流程，都需要按照这个顺序，从初始化开始
 150          **************************************************************************/
 151          uint8 RunASR()
 152          {
 153   1              uint8 i=0;
 154   1              uint8 asrflag=0;
 155   1              for (i=0; i<5; i++)                     //      防止由于硬件原因导致LD3320芯片工作不正常，所以一共尝试5次启动ASR识别流程
 156   1              {
 157   2                      LD_AsrStart();
 158   2                      delay(100);
 159   2                      if (LD_AsrAddFixed()==0)
 160   2                      {
 161   3                              LD_Reset();                     //      LD3320芯片内部出现不正常，立即重启LD3320芯片
 162   3                              delay(100);                     //      并从初始化开始重新ASR识别流程
 163   3                              continue;
 164   3                      }
 165   2                      delay(10);
 166   2                      if (LD_AsrRun() == 0)
 167   2                      {
 168   3                              LD_Reset();                     //      LD3320芯片内部出现不正常，立即重启LD3320芯片
 169   3                              delay(100);                     //      并从初始化开始重新ASR识别流程
 170   3                              continue;
 171   3                      }
 172   2                      asrflag=1;
 173   2                      break;                                  //      ASR流程启动成功，退出当前for循环。开始等待LD3320送出的中断信号
 174   2              }
 175   1      
 176   1              return asrflag;
 177   1      }
 178          /************************************************************************
C51 COMPILER V9.00   MAIN                                                                  04/24/2013 16:05:04 PAGE 4   

 179          功能描述： 中断处理函数
 180          调用函数： 
 181          入口参数： 
 182          返回函数： 
 183          **************************************************************************/
 184          void ExtInt0Handler(void) interrupt 0  
 185          {       
 186   1              ProcessInt0();                          //      LD3320 送出中断信号，包括ASR和播放MP3的中断，需要在中断处理函数中分别处理
 187   1              PrintCom("进入中断/n"); /*text.....*/
 188   1      }
 189          
 190          
 191          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    382    ----
   CONSTANT SIZE    =    165    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =      1       1
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
